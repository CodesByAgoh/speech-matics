<!DOCTYPE html>
<html>
<head>
    <title>Audio Recording</title>
</head>
<body>
    <textarea id="transcript"></textarea>
    <button id="recordButton">Record</button>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script> -->
    <!-- <script src="/socket.io/socket.io.js", type="application/json"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js" integrity="sha512-zoJXRvW2gC8Z0Xo3lBbao5+AS3g6YWr5ztKqaicua11xHo+AvE1b0lT9ODgrHTmNUxeCw0Ry4BGRYZfXu70weg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
    <script type="text/javascript" charset="utf-8">
        let socket = io();
        const recordButton = document.getElementById('recordButton');

        socket.on('connect', function() {
            console.log("connected!");
        });

        socket.on('receive', (data) => {
            console.log(data);
        });

        let mediaRecorder;
        let audioChunks = [];
        let recording = false; // Indicates whether recording is in progress

        recordButton.addEventListener('click', () => {
            if (!recording) {
                startRecording();
                recordButton.textContent = 'Stop';
            } else {
                stopRecording();
                recordButton.textContent = 'Record';
            }
        });

        function startRecording() {
            audioChunks = [];
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = function (event) {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstart = function () {
                        recording = true;
                    };

                    mediaRecorder.onstop = function () {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendAudioData(audioBlob);
                        recording = false;
                    };

                    mediaRecorder.start();
                })
                .catch(function (error) {
                    console.error('Error accessing the microphone:', error);
                });
            }

            function stopRecording() {
                if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            }

            function sendAudioData(audioBlob) {
                const xhr = new XMLHttpRequest();
                xhr.onload = function () {
                    if (this.readyState === 4 && this.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Server response:', response);
                        document.getElementById('transcript').value = response.transcript;
                    }
                };
                xhr.open('POST', 'http://127.0.0.1:5000/audio', true);
                const formData = new FormData();
                formData.append('audio_data', audioBlob);
                console.log(audioBlob);
                xhr.send(formData);
            }
    </script>
</body>
</html>